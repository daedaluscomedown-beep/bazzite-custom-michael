# ============================================================
# HTPC / MEDIA VARIANT
# Target: Bazzite (bootc / ostree)
# Focus: Stability, hardware decode, low latency playback
# Hardware: Ryzen 7 5800X3D + AMD RDNA (VCN)
# ============================================================

FROM ghcr.io/ublue-os/bazzite:latest

# ------------------------------------------------------------
# 1. Metadata
# ------------------------------------------------------------
LABEL org.opencontainers.image.title="bazzite-htpc-michael"
LABEL org.opencontainers.image.description="Optimized HTPC-focused Bazzite image with Kodi, VAAPI, and AMD VCN tuning"
LABEL org.opencontainers.image.authors="Michael O'Neill"

# ------------------------------------------------------------
# 2. Base OS prep
# ------------------------------------------------------------
RUN rpm-ostree install \
    kodi \
    kodi-pvr-iptvsimple \
    pipewire-jack-audio-connection-kit \
    wireplumber \
    mesa-va-drivers \
    mesa-vdpau-drivers \
    libva-utils \
    ffmpeg \
    && rpm-ostree cleanup -m

# ------------------------------------------------------------
# 3. AMD Video Decode / VAAPI tuning
# ------------------------------------------------------------
RUN mkdir -p /etc/environment.d && \
    printf '%s\n' \
    "LIBVA_DRIVER_NAME=radeonsi" \
    "VDPAU_DRIVER=radeonsi" \
    "AMD_VCN_ENABLE=1" \
    > /etc/environment.d/90-amd-vaapi.conf

# ------------------------------------------------------------
# 4. PipeWire low-latency defaults (safe for HTPC)
# ------------------------------------------------------------
RUN mkdir -p /etc/pipewire/pipewire.conf.d && \
    printf '%s\n' \
    "context.properties = {" \
    "  default.clock.rate = 48000" \
    "  default.clock.quantum = 256" \
    "  default.clock.min-quantum = 128" \
    "}" \
    > /etc/pipewire/pipewire.conf.d/10-htpc.conf

# ------------------------------------------------------------
# 5. Disable unnecessary services (HTPC focused)
# ------------------------------------------------------------
RUN systemctl disable \
    bluetooth.service \
    cups.service \
    ModemManager.service \
    avahi-daemon.service || true

# ------------------------------------------------------------
# 6. Kernel & VM tuning (HTPC-friendly)
# ------------------------------------------------------------
RUN mkdir -p /etc/sysctl.d && \
    printf '%s\n' \
    "vm.swappiness=10" \
    "vm.dirty_ratio=10" \
    "vm.dirty_background_ratio=5" \
    "kernel.sched_latency_ns=6000000" \
    "kernel.sched_min_granularity_ns=750000" \
    > /etc/sysctl.d/90-htpc.conf

# ------------------------------------------------------------
# 7. Filesystem tuning (BTRFS safe)
# ------------------------------------------------------------
RUN mkdir -p /etc/systemd/system/systemd-tmpfiles-setup.service.d && \
    printf '%s\n' \
    "[Service]" \
    "ExecStartPost=/usr/bin/btrfs filesystem defragment -r /var/lib || true" \
    > /etc/systemd/system/systemd-tmpfiles-setup.service.d/htpc-btrfs.conf

# ------------------------------------------------------------
# 8. Autologin hint (display manager handles final config)
# ------------------------------------------------------------
RUN mkdir -p /etc/profile.d && \
    printf '%s\n' \
    "export KODI_AE_SINK=PIPEWIRE" \
    > /etc/profile.d/htpc.sh

# ------------------------------------------------------------
# 9. Finalize
# ------------------------------------------------------------
CMD ["/sbin/init"]
