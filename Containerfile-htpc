# -----------------------------------------------------------------------------
# DECONFLICTION - HTPC EDITION (Console Mode)
# Hardware: Ryzen 5800X3D + RX 9070 (Same Engine, New Chassis)
# Base: Bazzite-Deck (Boots to Steam Game Mode)
# -----------------------------------------------------------------------------

ARG IMAGE_NAME="bazzite-deck"
ARG IMAGE_VENDOR="ublue-os"
ARG IMAGE_TAG="stable"
FROM ghcr.io/${IMAGE_VENDOR}/${IMAGE_NAME}:${IMAGE_TAG}

# -----------------------------------------------------------------------------
# 1. GLOBAL PERFORMANCE (RX 9070 Tuned)
# -----------------------------------------------------------------------------
RUN echo 'AMD_VULKAN_ICD=radv' >> /etc/environment && \
    echo 'RADV_PERFTEST=gpl,sam,video_decode' >> /etc/environment && \
    echo 'ENABLE_LAYER_MESA_ANTI_LAG=1' >> /etc/environment && \
    echo 'VKD3D_CONFIG=no_upload_hvv' >> /etc/environment && \
    echo 'MESA_SHADER_CACHE_MAX_SIZE=20G' >> /etc/environment && \
    echo 'MESA_SHADER_CACHE_SINGLE_FILE=1' >> /etc/environment

# -----------------------------------------------------------------------------
# 2. SYSTEM TUNING (Network & CPU)
# -----------------------------------------------------------------------------
RUN echo "vm.swappiness=1" > /etc/sysctl.d/99-htpc.conf && \
    echo "vm.max_map_count=1048576" >> /etc/sysctl.d/99-htpc.conf && \
    echo "net.ipv4.tcp_congestion_control=bbr" >> /etc/sysctl.d/99-htpc.conf && \
    echo "net.core.default_qdisc=cake" >> /etc/sysctl.d/99-htpc.conf

# -----------------------------------------------------------------------------
# 3. HTPC PACKAGES (Kodi + LACT)
# -----------------------------------------------------------------------------
# NOTE: Moonlight should be installed as a Flatpak after boot for stability.

COPY scripts/disable-terra.sh /tmp/disable-terra.sh
RUN chmod +x /tmp/disable-terra.sh && \
    /tmp/disable-terra.sh && \
    rm /tmp/disable-terra.sh

# Enable RPMFusion for Kodi dependencies
RUN dnf install -y https://mirrors.rpmfusion.org/free/fedora/rpmfusion-free-release-$(rpm -E %fedora).noarch.rpm \
    https://mirrors.rpmfusion.org/nonfree/fedora/rpmfusion-nonfree-release-$(rpm -E %fedora).noarch.rpm

# Enable LACT and Install Kodi
RUN dnf copr enable -y ilyaz/LACT && \
    rpm-ostree install \
    lact \
    kodi \
    kodi-inputstream-adaptive \
    kodi-pvr-iptvsimple

# -----------------------------------------------------------------------------
# 4. GAMEMODE PRIORITY
# -----------------------------------------------------------------------------
RUN mkdir -p /etc/gamemode.ini.d && \
    echo "[general]" > /etc/gamemode.ini && \
    echo "renice=10" >> /etc/gamemode.ini

# -----------------------------------------------------------------------------
# 5. SCRIPTS & NEXTDNS
# -----------------------------------------------------------------------------
# Install NextDNS
RUN curl -Lo /tmp/nextdns.tar.gz https://github.com/nextdns/nextdns/releases/download/v1.43.5/nextdns_1.43.5_linux_amd64.tar.gz && \
    tar -xzf /tmp/nextdns.tar.gz -C /usr/bin nextdns && \
    chmod +x /usr/bin/nextdns && \
    rm /tmp/nextdns.tar.gz

# Use the SAME update script (it auto-detects the 9070!)
COPY scripts/ /tmp/scripts/
RUN chmod +x /tmp/scripts/* && \
    mv /tmp/scripts/install-ge-proton.sh /usr/bin/ && \
    mv /tmp/scripts/update-deconfliction.sh /usr/bin/ && \
    rm -rf /tmp/scripts

RUN echo "âœ… Deconfliction HTPC Build Complete."